<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像から問題生成</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .question { margin: 20px 0; }
    .choices button { margin: 5px; }
    .result { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>画像から問題生成（英語/日本語対応）</h1>
  <input type="file" id="imageInput" accept="image/*,application/pdf">
  <select id="quizType">
    <option value="choice">選択式</option>
    <option value="writing">記述式</option>
  </select>
  <button onclick="uploadImage()">アップロードして問題生成</button>
  <div id="quizContainer"></div>

  <script>
    async function uploadImage() {
      const fileInput = document.getElementById('imageInput');
      const file = fileInput.files[0];
      const type = document.getElementById('quizType').value;

      if (!file) {
        alert("画像またはPDFを選択してください。");
      return;
      }

      const formData = new FormData();
      formData.append("file", file);
      formData.append("type", type);

      try {
        const res = await fetch("/upload", {
          method: "POST",
          body: formData
        });

      const data = await res.json();

        if (!data.success) {
          alert("エラー: " + data.error);
        return;
        }

        showQuiz(data.quizzes, type);

      } catch (err) {
        alert("通信エラーが発生しました: " + err.message);
      }
    }

    function showQuiz(quizzes, type) {
      const container = document.getElementById('quizContainer');
      container.innerHTML = "";

      quizzes.forEach((quiz, i) => {
        const div = document.createElement('div');
        div.className = "question";

        const qText = document.createElement('p');
        qText.textContent = `Q${i + 1}: ${quiz.question}`;
        div.appendChild(qText);

        const resultText = document.createElement('p');
        resultText.className = "result";

        if (type === "choice") {
          const choicesDiv = document.createElement('div');
          choicesDiv.className = "choices";

          quiz.choices.forEach((choice, j) => {
            const btn = document.createElement('button');
            btn.textContent = `${String.fromCharCode(65 + j)}. ${choice}`;
            btn.onclick = () => {
              if (choice === quiz.answer) {
                resultText.textContent = "✅ 正解!";
                resultText.style.color = "green";
              } else {
                resultText.textContent = `❌ 不正解... 正解は: ${quiz.answer}`;
                resultText.style.color = "red";
              }
            };
            choicesDiv.appendChild(btn);
          });

          div.appendChild(choicesDiv);
        } else if (type === "writing") {
          const input = document.createElement('input');
          input.type = "text";
          input.placeholder = "ここに答えを入力";

          const checkBtn = document.createElement('button');
          checkBtn.textContent = "解答を確認";
          checkBtn.onclick = () => {
            const userAns = input.value.trim();
            if (userAns === quiz.answer) {
              resultText.textContent = "✅ 正解!";
              resultText.style.color = "green";
            } else {
              resultText.textContent = `❌ 不正解... 正解は: ${quiz.answer}`;
              resultText.style.color = "red";
            }
          };

          div.appendChild(input);
          div.appendChild(checkBtn);
        }

        div.appendChild(resultText);
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
